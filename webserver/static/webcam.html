<html>
<head>
	<title>WebCam Page</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<style>
table {
	width: 100%;
	border-collapse: collapse;
}

table, th, td {
	border: 1px solid black;
}

th {
	background-color: #c0c0c0;
}
	</style>
	<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript">
// version: 20140707

function updateInitiativeText(data) {
	var html = '<table>\n<tr><th>Combat Round</th><th>\n';
	html += (data.round == undefined ? 0 : data.round) + "</th><th>Initiative</th></tr>\n";
	
	$.each(data.order, function(i,entry) {
		html += "<tr><td colspan=2>"+entry.name+"</td>";
		html += "<td>"+entry.initiative+"</td></tr>\n";
	});
	html += "</table>\n";
	$('#initiative').html(html);
}

function updateTokensText(data) {
	var html = '<table>';
	$.each(data, function(i, entry) {
		html += '<tr><td>'+entry.token+'</td><td>'+entry.name+'</td></tr>';
	});
	$('#tokenlist').html(html+'</table>');
}

function logMessage(msg, debug) {
	if (document.getElementById("debugcheck").checked) {
		$('#messageDiv').append((new Date()).toLocaleTimeString()+': '+msg+'<br>');
	} else if (!debug) {
		$('#messageDiv').html((new Date()).toLocaleTimeString()+': '+msg+'<br>');
	}
}

function createEventSource() {
	logMessage('Connecting to server');
	
	var source = new EventSource('updates/all');

	source.addEventListener('open', function(e) {
		if (!nologconnect) logMessage('Connection to server open');
	}, false);

	source.addEventListener('error', function(e) {
		if (event.target.readyState === EventSource.CLOSED) {
			source.close();
			logMessage('Lost connection to server');
//			alert("Lost the connection to the server.\nThe page will be reloaded.");
//			window.location.reload(false);
		} else if (event.target.readyState === EventSource.CONNECTING) {
			logMessage('Lost connection to server, attempting reconnect');
		} else {
			logMessage('Lost connection to server, unknown error');
//			alert("Lost the connection to the server.\nThe page will be reloaded.");
//			window.location.reload(false);
		}
	}, false);

	source.addEventListener('message', function(event) {
		var lines = event.data.split("\n");
		for (i = 0; i < lines.length; i++) {
			if (lines[i] === "initiative.json") {
				logMessage('updated initiatives');
				$.get('static/initiative.json?'+(new Date()).valueOf(), function(data) {
					updateInitiativeText(data);
				});
			} else if (lines[i] === "camera.jpg") {
				document.getElementById("photo1").src = "http://static.stevehodge.net/camera.jpg?"+(new Date()).valueOf();
				logMessage('updated image');
			} else if (lines[i] === "tokens.png") {
				document.getElementById("tokens1").src = "http://static.stevehodge.net/tokens.png?"+(new Date()).valueOf();
				logMessage('updated token overlay', true);
			} else if (lines[i] === "tokens.json") {
				logMessage('updated token legend', true);
				$.get('static/tokens.json?'+(new Date()).valueOf(), function(data) {
					updateTokensText(data);
				});
//			} else {
//				logMessage('unknown update: '+lines[i], true);
			}
		}
	}, false);
}


$(document).ready(function () {
	$.getJSON('static/initiative.json?'+(new Date()).valueOf(), function(data) {
		updateInitiativeText(data);
	});
	
	$.getJSON('static/tokens.json?'+(new Date()).valueOf(), function(data) {
		updateTokensText(data);
	});
	
	if(typeof(EventSource)!=="undefined") {
		createEventSource();
	} else {
		alert("Server-sent events not supported.\nGet a better browser - Firefox, Chrome, Safari, and Opera all support this, IE is shit");
	} 
});

function toggleTokens() {
	var checked = document.getElementById("tokens1check").checked;
	document.getElementById("tokens1").style.display = checked?"inline":"none";
	document.getElementById("tokenlist").style.display = checked?"inline":"none";
}

function openPhoto() {
	var win=window.open("photo1.jpg", '_blank');
	win.focus();
}
	</script>
</head>

<body>
	<div style="width: 75%; float: left;">
		<img width="75%" id="photo1" src="http://static.stevehodge.net/camera.jpg" style="position:absolute; z-index:1;"/>
		<img width="75%" id="tokens1" src="http://static.stevehodge.net/tokens.png" style="position:absolute; z-index:2;" onclick="openPhoto();"/>
		&nbsp;
	</div>
	<div style="width: 23%; height: 100%; float: right; height: 100%; overflow-y: auto;">
		<div id="initiative">
			<table>
				<tr><th>Combat Round</th><th>0</th><th>Initiative</th></tr>
			</table>
		</div> 
		<br/>
		<input id="tokens1check" type="checkbox" checked onclick="toggleTokens();">Show token overlay</input>
		<div id="tokenlist">
		</div>
		<div id="messageDiv" style="margin-top: 20px;">
		</div>
		<input id="debugcheck" type="checkbox">Keep message history</input>
	</div>
</body>
</html>
