<html>
<head>
	<title>WebCam Page</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<style>
table {
	width: 100%;
	border-collapse: collapse;
}

table, th, td {
	border: 1px solid black;
}

th {
	background-color: #c0c0c0;
}
	</style>
	<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript">
function updateInitiativeText(data) {
	var html = '<table>\n<tr><th>Combat Round</th><th>\n';
	html += (data.round == undefined ? 0 : data.round) + "</th><th>Initiative</th></tr>\n";
	
	$.each(data.order, function(i,entry) {
		html += "<tr><td colspan=2>"+entry.name+"</td>";
		html += "<td>"+entry.initiative+"</td></tr>\n";
	});
	html += "</table>\n";
	$('#initiative').html(html);
}

function updateTokensText(data) {
	var html = '<table>';
	$.each(data, function(i, entry) {
		html += '<tr><td>'+entry.token+'</td><td>'+entry.name+'</td></tr>';
	});
	$('#tokenlist').html(html+'</table>');
}
/*
function updateInitiativeText(text) {
	var lines = text.split("\n");
	var keys = new Object();

	// convert the text file to a map:
	for (var i = 0; i < lines.length; i++) {
		keys[lines[i].substr(0,lines[i].indexOf("="))] = lines[i].substr(lines[i].indexOf("=")+1);
	}

	var html = "";
	if (keys['lastindex'] != undefined) {
		var round = 0;
		if (keys['round'] != undefined) round = keys['round'];
		html += '<table>\n<tr><th>Combat Round</th><th>\n';
		html += round + "</th><th>Initiative</th></tr>\n";
		
		for (var i = 1; i <= keys['lastindex']; i++) {
			if (keys['name'+i] != undefined) {
				html += "<tr><td colspan=2>"+keys['name'+i]+"</td>";
			} else {
				html += "<tr><td colspan=2>"+keys['fixedname'+i]+"</td>";
			}
			html += "<td>"+keys['init'+i]+"</td></tr>\n";
		}
		html += "</table>\n";
	}
	$('#initiative').html(html);
}

function updateTokensText(text) {
	var lines = text.split("\n");
	var html = '<table>';

	for (var i = 0; i < lines.length-1; i+=2) {
		html += '<tr><td>'+lines[i]+'</td><td>'+lines[i+1]+'</td></tr>';
	}
	$('#tokenlist').html(html+'</table>');
}
*/
function createEventSource() {
	var source=new EventSource("main.php");
//	$('#photo1msg').append("<br>Source = "+source);
//	source.addEventListener('open', function(e) {
//		var now = new Date();
//		$('#photo1msg').append("<br>"+now.toLocaleTimeString()+": Event source open");
//	}, false);
	source.addEventListener('error', function(e) {
		console.log("error waiting for update");
		if (source.readyState == EventSource.CLOSED) {
			alert("Lost the connection to the server.\nThe page will be reloaded.");
			window.location.reload(false);
		}
	}, false);
	source.addEventListener('message', function(event) {
		var now = new Date();
		//$('#photo1msg').append("<br>"+now.toLocaleTimeString()+": Data: "+event.data);

		var lines = event.data.split("\n");
		for (i = 0; i < lines.length; i++) {
			if (lines[i] == "initiative.json") {
				$.get('initiative.json?'+(new Date()).valueOf(), function(data) {
					updateInitiativeText(data);
					//$('#photo1msg').append("<br>"+now.toLocaleTimeString()+": Initiative update");
				});
			} else if (lines[i] == "photo1.jpg") {
				//source.close();	// workaround for mobile safari - can't update the images while the EventSource is alive
				document.getElementById("photo1").src = "photo1.jpg?"+now.valueOf();
				//$('#photo1msg').append("<br>"+now.toLocaleTimeString()+": Image update");
				$('#photo1msg').text("Image updated at "+now.toLocaleTimeString());
				//createEventSource();	// workaround for mobile safari - can't update the images while the EventSource is alive
			} else if (lines[i] == "tokens1.png") {
				//source.close();	// workaround for mobile safari - can't update the images while the EventSource is alive
				document.getElementById("tokens1").src = "tokens1.png?"+now.valueOf();
				//$('#photo1msg').append("<br>"+now.toLocaleTimeString()+": Token update");
				//createEventSource();	// workaround for mobile safari - can't update the images while the EventSource is alive
			} else if (lines[i] == "tokens1.json") {
				$.get('tokens1.json?'+(new Date()).valueOf(), function(data) {
					updateTokensText(data);
					//$('#photo1msg').append("<br>"+now.toLocaleTimeString()+": Legend update");
				});
			}
		}
	}, false);
}


$(document).ready(function () {
	$.get('initiative.json?'+(new Date()).valueOf(), function(data) {
		updateInitiativeText(data);
	});
	$.get('tokens1.json?'+(new Date()).valueOf(), function(data) {
		updateTokensText(data);
	});
	
	if(typeof(EventSource)!=="undefined") {
		createEventSource();
	} else {
		alert("Server-sent events not supported.\nGet a better browser - Firefox, Chrome, Safari, and Opera all support this, IE is shit");
	} 
});

function toggleTokens() {
	var checked = document.getElementById("tokens1check").checked;
	document.getElementById("tokens1").style.display = checked?"inline":"none";
	document.getElementById("tokenlist").style.display = checked?"inline":"none";
}

function openPhoto() {
	var win=window.open("photo1.jpg", '_blank');
	win.focus();
}
	</script>
</head>

		<!--<a href="photo1.jpg" target="_blank" style="position:absolute; z-index:-1;"><img width="75%" id="photo1" src="photo1.jpg"/></a>-->
<body>
	<div style="width: 75%; float: left;">
		<img width="75%" id="photo1" src="photo1.jpg" style="position:absolute; z-index:1;"/>
		<img width="75%" id="tokens1" src="tokens1.png" style="position:absolute; z-index:2;" onclick="openPhoto();"/>
		&nbsp;
	</div>
	<div style="width: 23%; float: right;">
		<div id="initiative">
			<table>
				<tr><th>Combat Round</th><th>0</th><th>Initiative</th></tr>
			</table>
		</div> 
		<br/>
		<input id="tokens1check" type="checkbox" checked="true" onclick="toggleTokens();">Show token overlay</input>
		<div id="tokenlist">
		</div>
		<div id="photo1msg" style="margin-top: 20px;">
			Waiting for update
		</div>
	</div>
</body>
</html>
