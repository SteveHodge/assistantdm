<html>
<head>
	<title>WebCam Page</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<style>
#box-table{width:100%; border: 0px solid #000;}
.alignleft { float: left; }
.clear {
    clear: both;
}
	</style>
	<script type="text/javascript">
function getRequest() {
	if (window.XMLHttpRequest) {
		// code for IE7+, Firefox, Chrome, Opera, Safari
		return new XMLHttpRequest();
	} else {
		try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); } catch (e) {}
		try { return new ActiveXObject("Msxml2.XMLHTTP"); } catch (e) {}
		throw new Error("This browser does not support XMLHttpRequest.");
	}
}

function updateInitiativeText(text) {
	var lines = text.split("\n");
	var keys = new Object();

	// convert the text file to a map:
	for (var i = 0; i < lines.length; i++) {
		keys[lines[i].substr(0,lines[i].indexOf("="))] = lines[i].substr(lines[i].indexOf("=")+1);
	}

	var html = "";
	if (keys['lastindex'] != undefined) {
		var round = 0;
		if (keys['round'] != undefined) round = keys['round'];
		html += "<table border=1 width=200>\n<tr><th>Combat Round</th><th>\n";
		html += round + "</th><th>Initiative</th></tr>\n";
		
		for (var i = 1; i <= keys['lastindex']; i++) {
			if (keys['name'+i] != undefined) {
				html += "<tr><td colspan=2>"+keys['name'+i]+"</td>";
			} else {
				html += "<tr><td colspan=2>"+keys['fixedname'+i]+"</td>";
			}
			html += "<td>"+keys['init'+i]+"</td></tr>\n";
		}
		html += "</table>\n";
	}
	document.getElementById("initiative").innerHTML = html;
}

function sendRequest() {
	//alert("sending request");
	var req = getRequest();
	req.onreadystatechange = function() {
		if (req.readyState == 4) {
			if (req.status == 200) {
				// request is loaded successfully
				//alert("got response: '"+req.responseText+"'");
				if (req.responseText.substr(0,9) == "updated: ") {
					var file = req.responseText.substring(9,req.responseText.indexOf("\n"));
					if (file == "photo1.jpg") {
						var now = new Date();
						document.getElementById("photo1").src = "photo1.jpg?"+now.valueOf();
						document.getElementById("photo1msg").innerHTML = "Updated at "+now;
					} else if (file == "initiative.txt") {
						var text = req.responseText.substring(req.responseText.indexOf("\n")+1);
						updateInitiativeText(text);
					} else {
						alert("Updated '"+file+"'");
					}
				} else {
					document.getElementById("photo1msg").innerHTML = req.responseText;
				}
			} else {
				document.getElementById("photo1msg").innerHTML = "Error waiting for image refresh:<br/>"+req.status;
				//alert("Status = "+req.status);
			}
			sendRequest();
		}
	};
	req.open("GET", "old_main.php?"+(new Date()).valueOf(), true);
	req.send();
}

function load() {
	var req = getRequest();
	req.open("GET", "initiative.txt", false);
	req.send();
	if (req.status == 200) {
		updateInitiativeText(req.responseText);
	}
	sendRequest();
}

function toggleTokens() {
	var tokens = document.getElementById("tokens1");
	if (document.getElementById("tokens1check").checked) {
		tokens.style.display="inline";
	} else {
		tokens.style.display="none";
	}
}
	</script>
</head>

<body onLoad="load();">
	<div style="width: 80%; float: left;">
		<a href="photo1.jpg" target="_blank" style="position:absolute; z-index:1;"><img width="75%" id="photo1" src="photo1.jpg"/></a>
		<a href="photo1.jpg" target="_blank" style="position:absolute; z-index:2;"><img width="75%" id="tokens1" src="tokens1.png"/></a>
		&nbsp;
	</div>
	<div style="float: left;">
		<div id="initiative">
			<table border="1">
				<tr><th>Combat Round</th><th>0</th><th>Initiative</th></tr>
			</table>
		</div> 
		<br/>
		<input id="tokens1check" type="checkbox" checked="true" onclick="toggleTokens();">Show token overlay</input>
	</div>
</body>
</html>
