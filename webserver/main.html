<html>
<head>
	<title>WebCam Page</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<style>
#box-table{width:100%; border: 0px solid #000;}
.alignleft { float: left; }
.clear {
    clear: both;
}
	</style>
	<script type="text/javascript">
function getRequest() {
	if (window.XMLHttpRequest) {
		// code for IE7+, Firefox, Chrome, Opera, Safari
		return new XMLHttpRequest();
	} else {
		try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); } catch (e) {}
		try { return new ActiveXObject("Msxml2.XMLHTTP"); } catch (e) {}
		throw new Error("This browser does not support XMLHttpRequest.");
	}
}

function updateInitiativeText(text) {
	var lines = text.split("\n");
	var keys = new Object();

	// convert the text file to a map:
	for (var i = 0; i < lines.length; i++) {
		keys[lines[i].substr(0,lines[i].indexOf("="))] = lines[i].substr(lines[i].indexOf("=")+1);
	}

	var html = "";
	if (keys['lastindex'] != undefined) {
		var round = 0;
		if (keys['round'] != undefined) round = keys['round'];
		html += "<table border=1 width=200>\n<tr><th>Combat Round</th><th>\n";
		html += round + "</th><th>Initiative</th></tr>\n";
		
		for (var i = 1; i <= keys['lastindex']; i++) {
			if (keys['name'+i] != undefined) {
				html += "<tr><td colspan=2>"+keys['name'+i]+"</td>";
			} else {
				html += "<tr><td colspan=2>"+keys['fixedname'+i]+"</td>";
			}
			html += "<td>"+keys['init'+i]+"</td></tr>\n";
		}
		html += "</table>\n";
	}
	document.getElementById("initiative").innerHTML = html;
}

function updateTokensText(text) {
	var lines = text.split("\n");
	var html = "<table border=1 width=200>";

	for (var i = 0; i < lines.length-1; i+=2) {
		html += "<tr><td>";
		html += lines[i];
		html += "</td><td>";
		html += lines[i+1];		
		html += "</td></tr>";
	}
	
	html += "</table>";
	document.getElementById("tokenlist").innerHTML = html;
}

function getFile(filename) {
	var req = getRequest();
	req.open("GET", filename+"?"+(new Date()).valueOf(), false);
	req.send();
	if (req.status == 200) {
		return req.responseText;
	}
	return null;
}

function createEventSource() {
	var source=new EventSource("main.php");
	source.onerror=function(e) {
		alert("Error with EventSource: "+e);
	}
	source.onmessage=function(event) {
		var now = new Date();
		//alert("update "+event.data);
		if (event.data == "initiative.txt") {
			updateInitiativeText(getFile("initiative.txt"));
		} else if (event.data == "photo1.jpg") {
			source.close();	// workaround for mobile safari - can't update the images while the EventSource is alive
			document.getElementById("photo1").src = "photo1.jpg?"+now.valueOf();
			document.getElementById("photo1msg").innerHTML = "Last image update: "+now;
			createEventSource();	// workaround for mobile safari - can't update the images while the EventSource is alive
		} else if (event.data == "tokens1.png") {
			source.close();	// workaround for mobile safari - can't update the images while the EventSource is alive
			document.getElementById("tokens1").src = "tokens1.png?"+now.valueOf();
			createEventSource();	// workaround for mobile safari - can't update the images while the EventSource is alive
		} else if (event.data == "tokens1.txt") {
			updateTokensText(getFile("tokens1.txt"));
		}
	};
}


function load() {
	updateInitiativeText(getFile("initiative.txt"));
	updateTokensText(getFile("tokens1.txt"));
	
	if(typeof(EventSource)!=="undefined") {
		createEventSource();
	} else {
		alert("Server-sent events not supported.\nGet a better browser - Firefox, Chrome, Safari, and Opera all support this, IE is shit");
	} 
}

function toggleTokens() {
	var checked = document.getElementById("tokens1check").checked;
	document.getElementById("tokens1").style.display = checked?"inline":"none";
	document.getElementById("tokenlist").style.display = checked?"inline":"none";
}
	</script>
</head>

<body onLoad="load();">
	<div style="width: 80%; float: left;">
		<img id="photo1" width="75%" src="photo1.jpg" style="position:absolute; z-index:1;"/>
		<img id="tokens1" width="75%" src="tokens1.png" style="position:absolute; z-index:2;"/>
		&nbsp;
	</div>
	<div style="float: right;">
		<div id="initiative">
			<table border="1">
				<tr><th>Combat Round</th><th>0</th><th>Initiative</th></tr>
			</table>
		</div> 
		<br/>
		<input id="tokens1check" type="checkbox" checked="true" onclick="toggleTokens();">Show token overlay</input>
		<div id="tokenlist">
		</div>
		<div id="photo1msg" style="width: 200px; margin-top: 20px;">
			Waiting for update
		</div>
	</div>
</body>
</html>
